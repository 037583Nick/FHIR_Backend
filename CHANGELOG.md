# FHIR 後端更新日誌

## 版本 2.2.0 - 2025-08-26

### 🎯 重大改進

#### **STEMI 分析輸出遷移：PDF → PNG**
- **將 PDF 生成替換為高品質 PNG 輸出**
  - 提升視覺清晰度和兼容性
  - 大幅減少檔案大小（從 5MB+ 降至 ~300KB-1MB）
  - 改善跨平台支援
  - 更好地整合現代化網頁應用程式

#### **Triton Server 兼容性升級**
- **修復 ECG 模型標籤映射問題**
  - 解決索引 5 從 "EAR" 到正確 "NSR"（正常竇性心律）的映射
  - 為新版 Triton Server 22.03 實作手動標籤映射
  - 添加與舊版 trtis 客戶端行為的向後兼容性
  - 維持 NSR 檢測的 92.24% 置信度準確性

#### **性能優化**
- **簡化圖像處理流程**
  - 優化 PNG 壓縮設定（compress_level=6, optimize=True）
  - 智能解析度縮放（1200×600 基礎解析度）
  - 智能字型載入，支援基於專案的字型以兼容 Linux
  - 每個請求減少約 1-2 秒處理時間

### 🔧 技術增強

#### **圖像品質與解析度**
- **基於實際 ECG 尺寸的自適應畫布大小**
  - 基礎解析度：1200×600（從 1398×694 優化）
  - 維持 ECG 縱橫比，避免壓縮失真
  - 使用高品質 LANCZOS 重採樣進行圖像縮放
  - 專業醫療報告佈局，具有適當間距

#### **字型系統改進**
- **跨平台字型支援**
  - 從 Windows 特定路徑遷移到專案字型資料夾
  - 為 Linux 部署添加備用字型層次結構
  - 為高解析度顯示器優化字型大小（24px/28px）
  - 改善文字渲染品質

#### **程式碼品質與調試**
- **生產就緒的日誌記錄**
  - 註解調試訊息，提供更清潔的控制台輸出
  - 保留生產監控的基本錯誤日誌
  - 添加 PNG 優化追蹤的檔案大小報告
  - 改善錯誤處理和診斷

### 🚀 系統兼容性

#### **Triton Server 遷移**
- **成功從 Triton Server 20.03.1 遷移到 22.03**
  - 修復客戶端程式庫兼容性（trtis → tritonclient）
  - 實作手動標籤映射陣列
  - 保持原始模型推論準確性
  - 維持一致的輸出格式

#### **環境支援**
- **增強部署靈活性**
  - Linux 兼容的字型載入
  - 專案相對路徑處理
  - 移除 Windows 特定依賴
  - Docker 就緒配置

### 📊 性能指標

| 指標 | 改進前 | 改進後 | 提升 |
|------|--------|-------|------|
| 檔案大小 | 5MB+ | ~300KB-1MB | 70-85% ↓ |
| 處理時間 | 5 秒 | 3-4 秒 | 20-40% ↓ |
| 圖像品質 | PDF | 高解析度 PNG | 增強 |
| 兼容性 | 僅 Windows | 跨平台 | 通用 |

### 🔍 錯誤修復

- **修復 307 重定向問題**
  - 解決 FastAPI 自動斜線重定向
  - 優化路由定義以獲得一致行為
  - 改善請求處理性能

- **ECG 標籤映射修正**
  - 修復索引 5 → NSR 映射（之前錯誤顯示 EAR）
  - 恢復正確的置信度百分比計算
  - 維持與現有資料的向後兼容性

### 📝 維護

- **程式碼清理**
  - 移除測試檔案和調試腳本
  - 清理未使用的導入和依賴
  - 標準化錯誤處理模式
  - 改善程式碼文檔

---

## 遷移說明

### 生產部署注意事項：
1. 確保 `fonts/` 目錄包含所需的字型檔案
2. 將 Triton Server 更新到版本 22.03 或兼容版本
3. 驗證 ECG 模型標籤檔案是否正確映射
4. 測試 PNG 輸出品質和檔案大小

### 重大變更：
- 輸出格式從 PDF 改為 PNG
- Triton 客戶端程式庫更新（可能需要重新驗證模型）
- 字型路徑依賴更新以支援跨平台

---

## 貢獻者
- AI 開發團隊
- FHIR 後端維護團隊

---

*此更新大幅改善了 STEMI 分析流程，同時維持醫療準確性並增強使用者體驗。*
